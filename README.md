# Zot Registry on Hetzner Cloud

Automated deployment of a [zot](https://github.com/project-zot/zot) OCI registry on Hetzner Cloud with object storage backend.

## Overview

This repository contains automation to deploy a self-configuring zot container registry on Hetzner Cloud infrastructure. The setup includes:

- **Zot container** running via Podman
- **Systemd service** for automatic startup and management
- **Podman auto-update** for automatic container updates
- **Hetzner Object Storage** as the storage backend (S3-compatible)
- **Caddy reverse proxy** for public access
- **Automatic HTTPS** with Let's Encrypt (zero-config SSL/TLS)
- **Cloud-init** based bootstrap for zero-touch deployment

## Architecture

```
Internet → Caddy (80/443) → Zot Container (5000) → Hetzner Object Storage
```

The registry is exposed publicly through Caddy, which acts as a reverse proxy with automatic HTTPS. Authentication is handled via htpasswd, and all image data is stored in Hetzner Object Storage.

## Prerequisites

### SSH Key

You'll need an SSH public key to access the server. If you don't have one:

```bash
# Generate a new ED25519 key (recommended, secure)
ssh-keygen -t ed25519 -a 100 -f ~/.ssh/id_ed25519_zot -C "zot-registry-admin"

# Breakdown:
#   -t ed25519    Modern, secure algorithm
#   -a 100        100 KDF rounds (slows brute force)
#   -f ~/.ssh/... Custom output filename
#   -C "..."      Comment to identify key

# Or RSA 4096-bit if ED25519 is not supported
ssh-keygen -t rsa -b 4096 -a 100 -f ~/.ssh/id_rsa_zot -C "zot-registry-admin"

# Your keys will be at:
# Private: ~/.ssh/id_ed25519_zot
# Public:  ~/.ssh/id_ed25519_zot.pub (use this with setup.sh)
```

### Hetzner Cloud Account

1. Create a project in [Hetzner Cloud Console](https://console.hetzner.cloud/)
2. Generate an API token (optional, for CLI deployment)

### Hetzner Object Storage

1. Create an Object Storage bucket:
   - Go to Storage → Object Storage in Hetzner Cloud Console
   - Create a new bucket (e.g., `my-registry-storage`)
   - Note the bucket name and region (e.g., `fsn1`, `nbg1`, or `hel1`)

2. Generate S3 credentials:
   - Click on your bucket
   - Go to "S3 Keys" section
   - Create new credentials
   - Save the Access Key ID and Secret Access Key

### Domain Name (Required)

**HTTPS is required for the web UI authentication to work properly.**

- Register a domain name (e.g., `cr.yourdomain.com`)
- Point an A record to your server's IP address
- Caddy will automatically obtain and manage SSL certificates from Let's Encrypt

## Quick Start

### Option 1: Deploy via Hetzner Cloud Console

1. **Configure DNS (do this first):**
   - Create an A record pointing your domain (e.g., `cr.yourdomain.com`) to your future server IP
   - Or prepare to update DNS immediately after server creation

2. **Prepare your configuration:**
   - Run `./setup.sh` to generate `cloud-init-custom.yaml` with your domain, SSH key, and credentials
   - The script will prompt you for your domain name and automatically configure HTTPS
   - Or manually edit `cloud-init.yaml` and replace `:80` with your domain in the Caddyfile section

3. **Create a new server:**
   - Go to Hetzner Cloud Console
   - Click "Add Server"
   - Select location (should match your Object Storage region)
   - Choose Debian 12 (Bookworm) or Debian 11 (Bullseye)
   - Select server type (CX23 recommended, 2 vCPU / 4GB RAM)

4. **Configure Cloud-Init:**
   - Scroll to "Cloud config" section
   - Paste contents of `cloud-init-custom.yaml` (generated by setup.sh)

5. **Create the server:**
   - Click "Create & Buy now"
   - Note the server IP address
   - Update your DNS A record if you haven't already
   - Wait 2-3 minutes for the server to boot and configure

6. **Access your registry:**
   - Wait for DNS propagation: `dig +short cr.yourdomain.com`
   - Open `https://cr.yourdomain.com` in your browser
   - Caddy will automatically obtain an SSL certificate (may take 30-60 seconds)
   - Login with: `admin` / `changeme`
   - **Change the default password immediately!**

### Option 2: Deploy via Hetzner CLI

```bash
# Install hcloud CLI
brew install hcloud  # macOS
# or
snap install hcloud  # Linux

# Authenticate
hcloud context create my-project

# Generate customized cloud-init with your domain and credentials
./setup.sh

# Create server with cloud-init
hcloud server create \
  --name zot-registry \
  --type cx23 \
  --image debian-12 \
  --location fsn1 \
  --user-data-from-file cloud-init-custom.yaml

# Note the server IP and update your DNS A record
# Access your registry at https://your-domain.com once DNS propagates
```

## Post-Deployment Configuration

### 1. Update S3 Credentials

If you didn't modify the cloud-init file before deployment:

```bash
ssh root@YOUR_SERVER_IP

# Edit credentials
nano /etc/zot/credentials.env

# Update with your actual credentials:
AWS_ACCESS_KEY_ID=your_access_key_id
AWS_SECRET_ACCESS_KEY=your_secret_access_key

# Update bucket configuration
nano /etc/zot/config.json

# Update the bucket name and regionendpoint in storageDriver section

# Restart service
systemctl restart zot.service
```

### 2. Change Default Password

```bash
# Generate new password
htpasswd -Bbn newuser newpassword > /etc/zot/htpasswd

# Restart service
systemctl restart zot.service
```

### 3. Set Up Automatic HTTPS (Recommended)

Caddy automatically obtains and renews SSL/TLS certificates from Let's Encrypt!

```bash
# Edit Caddyfile
nano /etc/caddy/Caddyfile

# Replace :80 with your domain name:
# Change:  :80 {
# To:      your-registry.example.com {

# Or uncomment the example section and modify it

# Restart Caddy
systemctl restart caddy

# That's it! Caddy automatically:
# - Obtains Let's Encrypt certificate
# - Configures HTTPS
# - Redirects HTTP to HTTPS
# - Renews certificates before expiration
```

Check certificate status:
```bash
# View Caddy logs
journalctl -u caddy -f

# Check if HTTPS is working
curl https://your-registry.example.com/v2/
```

## Usage

### Push an Image

```bash
# Log in to your registry
podman login your-domain.com
# or
docker login your-domain.com

# Tag an image
podman tag myimage:latest your-domain.com/myimage:latest

# Push the image
podman push your-domain.com/myimage:latest
```

### Pull an Image

```bash
podman pull your-domain.com/myimage:latest
```

## Management

### Check Service Status

```bash
systemctl status zot.service
```

### View Logs

```bash
# Service logs
journalctl -u zot.service -f

# Application logs
tail -f /var/log/zot/zot.log

# Audit logs
tail -f /var/log/zot/audit.log
```

### Restart Service

```bash
systemctl restart zot.service
```

### Podman Auto-Update

The container is configured to automatically check for updates daily at midnight using podman's auto-update feature.

```bash
# Check auto-update timer status
systemctl status podman-auto-update.timer

# View last auto-update run
systemctl status podman-auto-update.service

# Manually check for updates (dry-run)
podman auto-update --dry-run

# Manually trigger update
podman auto-update

# View auto-update logs
journalctl -u podman-auto-update.service
```

The container has the `io.containers.autoupdate=registry` label, which means podman will:
1. Check the container registry for image updates
2. Pull the new image if available
3. Restart the container with the new image
4. Rollback to the previous version if the restart fails

### Update Caddy

To update Caddy to the latest version:

```bash
# Download latest binary
curl -L "https://github.com/caddyserver/caddy/releases/latest/download/caddy_linux_amd64.tar.gz" -o /tmp/caddy.tar.gz

# Extract and replace
tar -xzf /tmp/caddy.tar.gz -C /tmp
mv /tmp/caddy /usr/local/bin/caddy
chmod +x /usr/local/bin/caddy
rm /tmp/caddy.tar.gz

# Restart Caddy
systemctl restart caddy

# Verify version
/usr/local/bin/caddy version
```

Or use the built-in upgrade command (requires existing Caddy installation):
```bash
caddy upgrade
systemctl restart caddy
```

## Configuration Files

### zot-config.json

Template configuration file for zot with S3 storage backend. Key sections:

- **storage.storageDriver**: S3 backend configuration
- **http.auth**: Authentication settings (htpasswd)
- **http.accessControl**: Repository access policies
- **log**: Logging configuration

### zot.service

Systemd service unit file that:
- Manages the zot Podman container lifecycle
- Automatically restarts on failure
- Uses Type=notify for proper systemd integration
- Configures container with auto-update label
- Injects S3 credentials from environment file
- Includes SELinux labels (Z) for volume mounts

### Caddyfile

**Single source of truth** for Caddy configuration.

This file:
- Configures reverse proxy to zot container
- Handles automatic HTTPS with Let's Encrypt
- Sets proper headers for container registry
- Configures unlimited request buffers for large uploads
- Sets appropriate timeouts for image operations
- Enables access logging

**Important**: This file is deployed via cloud-init's `write_files` section. Edit this file and regenerate cloud-init with `./setup.sh` to apply changes.

### caddy.service

Systemd service unit for Caddy:
- Runs Caddy as caddy user/group
- Type=notify for proper systemd integration
- Automatic reload support
- Security hardening (ProtectSystem, PrivateTmp)
- CAP_NET_BIND_SERVICE capability for binding to privileged ports

### cloud-init.yaml

Bootstrap script that:
- Uses `write_files` to deploy Caddyfile from repository
- Downloads Caddy binary from official GitHub releases
- Installs Podman and utilities
- Creates Caddy user and directory structure
- Configures zot and systemd services
- Enables podman auto-update timer
- Sets up firewall rules
- Starts all services

**Note**: The Caddyfile content comes from the separate `Caddyfile` file via `write_files` section.

## Security Considerations

1. **Change default passwords** immediately after deployment
2. **Use SSL/TLS** for production deployments
3. **Restrict firewall rules** to necessary ports only
4. **Secure S3 credentials** - never commit them to git
5. **Automatic updates** - podman auto-update keeps zot container current
6. **System updates** - keep OS and packages updated with unattended-upgrades
7. **Access control** - configure appropriate user permissions in config.json
8. **Network security** - use Hetzner Cloud Firewalls for additional protection
9. **Caddy binary** - downloaded directly from official GitHub releases (no third-party repos)
10. **Minimal dependencies** - fewer packages means smaller attack surface

## Troubleshooting

### Service won't start

```bash
# Check service status
systemctl status zot.service

# Check Podman logs
podman logs zot

# Check container status
podman ps -a

# Verify S3 credentials
grep AWS /etc/zot/credentials.env

# Test S3 connectivity
podman run --rm \
  -e AWS_ACCESS_KEY_ID=your_key \
  -e AWS_SECRET_ACCESS_KEY=your_secret \
  amazon/aws-cli \
  s3 ls --endpoint-url=https://your-bucket.fsn1.your-objectstorage.com
```

### Can't connect to registry

```bash
# Check if Caddy is running
systemctl status caddy

# Check Caddy logs
journalctl -u caddy -n 50

# Check if zot container is running
podman ps | grep zot

# Test local connectivity to zot
curl http://localhost:5000/v2/

# Test through Caddy
curl http://localhost:80/v2/

# Check firewall
ufw status

# Validate Caddyfile syntax
caddy validate --config /etc/caddy/Caddyfile
```

### Auto-update not working

```bash
# Check timer is active
systemctl status podman-auto-update.timer

# Check last run
journalctl -u podman-auto-update.service -n 50

# Verify container label
podman inspect zot | grep autoupdate

# Manually trigger update
podman auto-update
```

### HTTPS/Certificate issues

```bash
# Check Caddy logs for certificate errors
journalctl -u caddy -n 100 | grep -i certificate

# Verify domain points to your server
dig +short your-domain.com

# Check if ports are accessible
curl -v http://your-domain.com
curl -v https://your-domain.com

# Force certificate renewal
caddy reload --config /etc/caddy/Caddyfile
```

Common issues:
- DNS not pointing to server IP (wait for DNS propagation)
- Port 80/443 blocked by firewall
- Domain validation failing (ensure ports are open)
- Rate limits from Let's Encrypt (use staging environment for testing)

### S3 connection errors

- Verify bucket name and region are correct
- Check that S3 credentials have proper permissions
- Ensure bucket endpoint URL matches your region
- Test credentials with aws-cli or s3cmd

## Cost Estimation

Example monthly costs for Hetzner:

- **CX23 server** (2 vCPU, 4GB RAM): ~€6.39/month
- **Object Storage**: €0.0049/GB/month + €0.01/GB transfer
- **Traffic**: 20TB included with server

Total: ~€7-12/month for small to medium usage

## Advanced Configuration

### Custom Storage Backend

The default configuration uses Hetzner Object Storage:

```json
{
  "storage": {
    "storageDriver": {
      "name": "s3",
      "region": "eu-central-1",
      "bucket": "my-registry-storage",
      "regionendpoint": "fsn1.your-objectstorage.com"
    }
  }
}
```

Available Hetzner regions:
- `fsn1.your-objectstorage.com` - Falkenstein, Germany
- `nbg1.your-objectstorage.com` - Nuremberg, Germany
- `hel1.your-objectstorage.com` - Helsinki, Finland

For other S3-compatible storage (e.g., AWS S3):

```json
{
  "storage": {
    "storageDriver": {
      "name": "s3",
      "region": "us-east-1",
      "bucket": "my-bucket",
      "regionendpoint": "s3.amazonaws.com"
    }
  }
}
```

### High Availability Setup

For production deployments:

1. Use multiple zot instances behind a load balancer
2. Share the same S3 bucket across instances
3. Use Hetzner Load Balancer for distribution
4. Configure health checks on `/v2/` endpoint

### Monitoring

Add monitoring with Prometheus:

```json
{
  "extensions": {
    "metrics": {
      "enable": true,
      "prometheus": {
        "path": "/metrics"
      }
    }
  }
}
```

## Resources

- [Zot Documentation](https://zotregistry.dev/)
- [Zot GitHub Repository](https://github.com/project-zot/zot)
- [Hetzner Cloud Docs](https://docs.hetzner.com/cloud/)
- [Hetzner Object Storage](https://docs.hetzner.com/storage/object-storage/)
- [OCI Distribution Spec](https://github.com/opencontainers/distribution-spec)

## License

This deployment automation is provided as-is for use with the zot registry project.

## Support

For issues with:
- **This deployment**: Open an issue in this repository
- **Zot itself**: Visit [project-zot/zot](https://github.com/project-zot/zot)
- **Hetzner services**: Contact [Hetzner Support](https://docs.hetzner.com/)

